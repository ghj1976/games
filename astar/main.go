package main

import (
	"image/color"
	"log"

	"github.com/hajimehoshi/ebiten/v2"
)

var (
	aMap *AStarMap
)

var (
	MapWidth     int
	MapHeight    int
	ScreenWidth  int
	ScreenHeight int
)

type Game struct {
}

// Update 逻辑刷新
func (g *Game) Update() error {
	aMap.Update()
	return nil
}

// Draw 绘图
func (g *Game) Draw(screen *ebiten.Image) {

	// if ebiten.IsDrawingSkipped() {
	// 	return nil
	// }

	screen.Fill(color.RGBA{132, 132, 132, 255})
	square := ebiten.NewImage(MapWidth, MapHeight)
	square.Fill(color.Black)

	aMap.Draw(square)

	// 把map区域画在地图上。
	opts := &ebiten.DrawImageOptions{}
	opts.GeoM.Translate(float64(ScreenWidth)/2.0-float64(MapWidth)/2.0, float64(ScreenHeight)/2.0-float64(MapHeight)/2.0)
	screen.DrawImage(square, opts) // 游戏地图区域绘制

}

// Layout
func (g *Game) Layout(outsideWidth, outsideHeight int) (int, int) {
	return ScreenWidth, ScreenHeight
}

func main() {
	prepareImage()

	// 随机地图
	// rows, cols := 50, 50
	// aMap = prepareData1(rows, cols)

	// 坦克大战的地图
	// rows, cols := 26, 26
	// mt := "0000000000000000000000000000000000000000000000000000001100110011001100110011000011001100110011001100110000110011001000010011001100001100110010000100110011000011001100115511001100110000110011001155110011001100001100110011001100110011000011001100000000001100110000110011000000000011001100000000000011001100000000000000000000110011000000000011001111000000000011110011550011110000000000111100550000000000110011000000000000000000001111110000000000001100110011111100110011000011001100110011001100110000110011001100110011001100001100110011001100110011000011001100000000001100110000110011000000000011001100001100110001111000110011000000000000019910000000000000000000000199100000000000"
	// aMap = prepareData2(rows, cols, mt)

	// U 型地图
	rows, cols := 26, 26
	mt := `
	00000000000000000000000000
	00000000000000000000000000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00000000000000000000001000
	00111111111111111111111000
	00000000000000000000000000
	00000000000000000000000000
	`
	aMap = prepareData2(rows, cols, mt)

	MapWidth = 2 + (5+2)*cols
	MapHeight = 2 + (5+2)*rows
	ScreenWidth = (MapWidth/100 + 1) * 100
	ScreenHeight = (MapHeight/100 + 1) * 100

	go aMap.FindPath(Point{Row: 0, Col: 0}, Point{Row: rows - 1, Col: cols - 1})

	ebiten.SetWindowSize(ScreenWidth*2, ScreenHeight*2)
	ebiten.SetWindowTitle("A*寻路算法演示")
	if err := ebiten.RunGame(&Game{}); err != nil {
		log.Fatal(err)
	}
}
